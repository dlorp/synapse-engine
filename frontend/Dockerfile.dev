# =============================================================================
# MAGI Frontend - Development Dockerfile
# =============================================================================
# Development environment with Vite dev server and Hot Module Replacement (HMR)
# For production builds, use Dockerfile (nginx-based)
#
# Build arguments:
#   NODE_VERSION: Node.js version to use (default: 20)
#
# Usage:
#   docker build -f Dockerfile.dev -t magi-frontend-dev .
#   docker run -p 5173:5173 -v $(pwd)/src:/app/src magi-frontend-dev
# =============================================================================

ARG NODE_VERSION=20
FROM node:${NODE_VERSION}-alpine

# Set environment variables
ENV NODE_ENV=development \
    NPM_CONFIG_UPDATE_NOTIFIER=false \
    NPM_CONFIG_FUND=false

# Install additional tools for development
# - wget: Required for health checks
RUN apk add --no-cache wget

# Set working directory
WORKDIR /app

# Copy package files first for better layer caching
# If package.json doesn't change, npm install layer is cached
COPY package*.json ./

# Install dependencies using npm ci (clean install)
# npm ci is faster and more reliable than npm install for CI/CD
# --prefer-offline: Use cached packages when available
# --no-audit: Skip security audit (faster for development)
RUN npm ci --prefer-offline --no-audit

# Copy application source code
# In docker-compose, this will be overridden by volume mount for hot reload
COPY . .

# Expose Vite dev server port
EXPOSE 5173

# Health check - verify Vite dev server is responding
HEALTHCHECK --interval=15s --timeout=5s --retries=3 --start-period=20s \
    CMD wget --no-verbose --tries=1 --spider http://localhost:5173 || exit 1

# Start Vite dev server
# --host: Listen on all interfaces (required for Docker)
# --port 5173: Explicit port (Vite default)
# --strictPort: Fail if port is already in use
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "5173", "--strictPort"]

# =============================================================================
# Development Notes:
# =============================================================================
# 1. Hot Module Replacement (HMR) works when source code is volume-mounted
# 2. node_modules should NOT be volume-mounted (use anonymous volume)
# 3. Vite's --host 0.0.0.0 is required for Docker networking
# 4. Health check ensures Vite is serving, not just that container is running
# 5. Alpine base image keeps the image size small (~150MB vs ~1GB for node:20)
#
# Volume Mount Pattern (in docker-compose.yml):
#   volumes:
#     - ./src:/app/src
#     - /app/node_modules  # Anonymous volume - don't overwrite with host
#
# This allows:
# - Source code changes trigger HMR
# - node_modules stay in container (faster, platform-specific binaries)
# =============================================================================
