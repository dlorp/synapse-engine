# =============================================================================
# MAGI Frontend - Nginx Configuration
# =============================================================================
# Production configuration for serving the React SPA with:
# - Gzip compression
# - SPA routing fallback
# - API proxy to backend
# - WebSocket proxy
# - Security headers
# - Caching policies
# =============================================================================

# Upstream backend server
# This defines the backend API server that nginx will proxy to
upstream backend {
    # In docker-compose, "backend" resolves to the backend service
    server backend:8000;

    # Connection settings
    keepalive 32;  # Keep connections alive for reuse
}

# Main server block
server {
    # Listen on port 80 (HTTP)
    listen 80;
    listen [::]:80;

    server_name _;  # Catch-all server name

    # Root directory for static files
    root /usr/share/nginx/html;
    index index.html;

    # Charset
    charset utf-8;

    # ---------------------------------------------------------------------------
    # Logging
    # ---------------------------------------------------------------------------
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # ---------------------------------------------------------------------------
    # Gzip Compression
    # ---------------------------------------------------------------------------
    # Compress responses for faster transfer times
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/rss+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;

    # ---------------------------------------------------------------------------
    # Security Headers
    # ---------------------------------------------------------------------------
    # Add security headers to all responses
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Content Security Policy (adjust as needed)
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self';" always;

    # ---------------------------------------------------------------------------
    # Health Check Endpoint
    # ---------------------------------------------------------------------------
    # Simple health check for Docker/Kubernetes
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ---------------------------------------------------------------------------
    # API Proxy
    # ---------------------------------------------------------------------------
    # Proxy API requests to backend service
    location /api/ {
        # Proxy settings
        proxy_pass http://backend/api/;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # Connection reuse
        proxy_set_header Connection "";

        # Don't cache API responses
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate" always;
    }

    # ---------------------------------------------------------------------------
    # WebSocket Proxy
    # ---------------------------------------------------------------------------
    # Proxy WebSocket connections to backend
    location /ws {
        proxy_pass http://backend/ws;
        proxy_http_version 1.1;

        # WebSocket headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts for WebSocket (long-lived connections)
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;

        # Disable buffering for WebSocket
        proxy_buffering off;
    }

    # ---------------------------------------------------------------------------
    # Static Assets with Caching
    # ---------------------------------------------------------------------------
    # Cache static assets with hash in filename
    # Vite generates files like main.abc123.js with content hash
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;

        # CORS headers for fonts (if needed)
        add_header Access-Control-Allow-Origin "*";
    }

    # ---------------------------------------------------------------------------
    # SPA Routing Fallback
    # ---------------------------------------------------------------------------
    # For single-page applications, all routes should serve index.html
    # Let the React router handle routing on the client side
    location / {
        try_files $uri $uri/ /index.html;

        # Cache index.html for short time only
        add_header Cache-Control "no-cache, must-revalidate";
    }

    # ---------------------------------------------------------------------------
    # Error Pages
    # ---------------------------------------------------------------------------
    # Custom error pages (optional)
    error_page 404 /index.html;  # SPA routing
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}

# =============================================================================
# Configuration Notes:
# =============================================================================
# 1. API Proxy (/api/):
#    - Forwards all API requests to backend:8000
#    - Maintains headers for proper request context
#    - No caching for dynamic content
#
# 2. WebSocket Proxy (/ws):
#    - Upgrades HTTP to WebSocket protocol
#    - Long timeouts (7 days) for persistent connections
#    - No buffering for real-time communication
#
# 3. Static Asset Caching:
#    - Files with hash in name cached for 1 year
#    - Cache-Control: immutable prevents revalidation
#    - index.html not cached (entry point must be fresh)
#
# 4. SPA Routing:
#    - All routes fall back to index.html
#    - React Router handles client-side routing
#    - 404s serve index.html, not error page
#
# 5. Security Headers:
#    - X-Frame-Options: Prevent clickjacking
#    - X-Content-Type-Options: Prevent MIME sniffing
#    - X-XSS-Protection: Enable XSS filter
#    - Adjust CSP as needed for your security requirements
#
# 6. Gzip Compression:
#    - Reduces transfer size by ~70% for text content
#    - Applied to JS, CSS, HTML, JSON, SVG
#    - Min size 1KB (don't compress tiny files)
#
# 7. Connection Pooling:
#    - keepalive 32 maintains pool of connections to backend
#    - Reduces connection overhead
#    - Improves backend performance
# =============================================================================
