# =============================================================================
# S.Y.N.A.P.S.E. ENGINE - Monitoring Stack Extension
# =============================================================================
# Extends docker-compose.yml with monitoring services for CGRAG observability
#
# Services Added:
#   - Qdrant: High-performance vector database (optional, FAISS fallback)
#   - Prometheus: Metrics collection and alerting
#   - Grafana: Metrics visualization and dashboards
#   - Redis Exporter: Redis metrics for Prometheus
#
# Usage:
#   # Start with monitoring enabled
#   docker-compose -f docker-compose.yml -f docker-compose.monitoring.yml up -d
#
#   # Stop monitoring stack
#   docker-compose -f docker-compose.yml -f docker-compose.monitoring.yml down
#
#   # View Prometheus: http://localhost:9090
#   # View Grafana: http://localhost:3000 (admin/admin)
# =============================================================================

# =============================================================================
# Additional Volumes for Monitoring
# =============================================================================
volumes:
  # Qdrant vector database storage
  qdrant_data:
    name: synapse_qdrant_data
    driver: local

  # Prometheus TSDB storage
  prometheus_data:
    name: synapse_prometheus_data
    driver: local

  # Grafana dashboards and config
  grafana_data:
    name: synapse_grafana_data
    driver: local

# =============================================================================
# Monitoring Services
# =============================================================================
services:
  # ---------------------------------------------------------------------------
  # Qdrant - Vector Database (optional, high-performance alternative to FAISS)
  # ---------------------------------------------------------------------------
  synapse_qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: synapse_qdrant
    restart: unless-stopped

    # Port mapping
    # 6333: HTTP API
    # 6334: gRPC API (optional, for high-throughput operations)
    ports:
      - "6333:6333"
      - "6334:6334"

    # Environment variables
    environment:
      # Enable telemetry (metrics endpoint)
      - QDRANT__TELEMETRY_DISABLED=false

      # Performance tuning for CGRAG workload
      # Optimize for read-heavy operations with frequent updates
      - QDRANT__STORAGE__PERFORMANCE__MAX_SEARCH_THREADS=0  # Auto-detect CPU count
      - QDRANT__STORAGE__OPTIMIZERS__DEFAULT_SEGMENT_NUMBER=4
      - QDRANT__STORAGE__WAL__WAL_CAPACITY_MB=128

      # Memory configuration
      # Allow up to 2GB for vector cache
      - QDRANT__STORAGE__ON_DISK_PAYLOAD=false  # Keep payload in memory for speed

      # API configuration
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334

    # Volume for persistent storage
    volumes:
      - qdrant_data:/qdrant/storage
      # Optional: custom config file
      # - ./config/qdrant/config.yaml:/qdrant/config/production.yaml:ro

    # Health check - verify Qdrant API responding
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6333/"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 15s

    # Resource limits
    # Qdrant benefits from more memory for vector caching
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 3G
        reservations:
          cpus: '1.0'
          memory: 2G

    networks:
      - synapse_net

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Redis Exporter - Metrics for Prometheus
  # ---------------------------------------------------------------------------
  redis-exporter:
    image: oliver006/redis_exporter:v1.55.0-alpine
    container_name: synapse_redis_exporter
    restart: unless-stopped

    # Port mapping
    # 9121: Metrics endpoint
    ports:
      - "9121:9121"

    # Environment variables
    environment:
      # Redis connection string
      - REDIS_ADDR=synapse_redis:6379
      - REDIS_PASSWORD=${MEMEX_PASSWORD:-change_this_secure_redis_password}

      # Export key-level metrics for CGRAG cache analysis
      - REDIS_EXPORTER_CHECK_KEYS=cgrag:*,embedding:*

      # Debug mode (set to "true" for troubleshooting)
      - REDIS_EXPORTER_DEBUG=false

    # Depends on Redis being healthy
    depends_on:
      synapse_redis:
        condition: service_healthy

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9121/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Resource limits (lightweight exporter)
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M

    networks:
      - synapse_net

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # ---------------------------------------------------------------------------
  # Prometheus - Metrics Collection and Alerting
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:v2.48.1
    container_name: synapse_prometheus
    restart: unless-stopped

    # Port mapping
    # 9090: Web UI and API
    ports:
      - "9090:9090"

    # Command arguments
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--storage.tsdb.retention.size=10GB'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'  # Allow config reload via API

    # Volume mounts
    volumes:
      # Configuration files
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./config/prometheus/rules:/etc/prometheus/rules:ro

      # Data persistence
      - prometheus_data:/prometheus

    # Depends on exporters and backend
    depends_on:
      synapse_core:
        condition: service_healthy
      redis-exporter:
        condition: service_healthy

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

    networks:
      - synapse_net

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Grafana - Metrics Visualization
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:10.2.3
    container_name: synapse_grafana
    restart: unless-stopped

    # Port mapping
    # 3000: Web UI
    ports:
      - "3000:3000"

    # Environment variables
    environment:
      # Admin credentials (CHANGE IN PRODUCTION)
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}

      # Anonymous access (disable in production)
      - GF_AUTH_ANONYMOUS_ENABLED=false

      # Server configuration
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_SERVER_SERVE_FROM_SUB_PATH=false

      # Data source provisioning
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning

      # Plugins
      - GF_INSTALL_PLUGINS=redis-datasource,marcusolsson-json-datasource

      # Logging
      - GF_LOG_LEVEL=info

    # Volume mounts
    volumes:
      # Persistent data (dashboards, users, etc.)
      - grafana_data:/var/lib/grafana

      # Provisioned data sources (Prometheus)
      - ./config/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro

      # Provisioned dashboards
      - ./config/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards:ro

    # Depends on Prometheus
    depends_on:
      prometheus:
        condition: service_healthy

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    networks:
      - synapse_net

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# =============================================================================
# Extended Environment Variables for CGRAG
# =============================================================================
# Add these to your .env file or docker-compose.yml synapse_core service:
#
# # Vector Database Selection
# RECALL_VECTOR_DB=auto               # auto|qdrant|faiss
# RECALL_QDRANT_URL=http://synapse_qdrant:6333
# RECALL_QDRANT_COLLECTION=synapse_cgrag
#
# # Hybrid Search Configuration
# RECALL_HYBRID_SEARCH=true           # Enable BM25 + Vector hybrid search
# RECALL_HYBRID_ALPHA=0.7             # Vector weight (0.0=BM25 only, 1.0=Vector only)
# RECALL_HYBRID_RRF_K=60              # Reciprocal Rank Fusion parameter
#
# # Reranker Configuration
# RECALL_RERANKER_ENABLED=true        # Enable cross-encoder reranking
# RECALL_RERANKER_MODEL=cross-encoder/ms-marco-MiniLM-L-6-v2
# RECALL_RERANKER_TOP_K=100           # Rerank top 100 candidates
# RECALL_RERANKER_BATCH_SIZE=32       # Batch size for reranking
#
# # Knowledge Graph Configuration
# RECALL_KG_ENABLED=true              # Enable knowledge graph enhancement
# RECALL_KG_ENTITY_EXTRACTION=spacy   # spacy|transformers
# RECALL_KG_MAX_HOPS=2                # Max graph traversal depth
#
# # Performance Tuning
# RECALL_EMBEDDING_BATCH_SIZE=64      # Embedding generation batch size
# RECALL_PREFETCH_EMBEDDINGS=true     # Pre-compute embeddings for hot data
# RECALL_ASYNC_INDEXING=true          # Background indexing for new docs
#
# # Metrics and Monitoring
# PROMETHEUS_ENABLED=true             # Enable Prometheus metrics
# PROMETHEUS_PORT=8000                # Expose metrics on /metrics endpoint
# GRAFANA_ADMIN_PASSWORD=change_me    # Grafana admin password
# =============================================================================

# =============================================================================
# Notes:
# =============================================================================
# 1. Qdrant vs FAISS:
#    - Qdrant: Better for production, supports filtering, updates, gRPC
#    - FAISS: Faster for read-only workloads, lower memory footprint
#    - Auto-detection: Use Qdrant on Metal-enabled systems, FAISS otherwise
#
# 2. Monitoring Stack Resources:
#    - Prometheus: ~1-2GB RAM for 30-day retention
#    - Grafana: ~256-512MB RAM
#    - Redis Exporter: ~64-128MB RAM
#    - Qdrant: ~2-3GB RAM (depends on index size)
#    - Total: ~4-6GB additional RAM
#
# 3. Data Persistence:
#    - All volumes are named and persisted across restarts
#    - Backup Qdrant: docker cp synapse_qdrant:/qdrant/storage ./backups/
#    - Backup Prometheus: docker cp synapse_prometheus:/prometheus ./backups/
#    - Backup Grafana: docker cp synapse_grafana:/var/lib/grafana ./backups/
#
# 4. Access URLs:
#    - Prometheus: http://localhost:9090
#    - Grafana: http://localhost:3000 (admin/admin)
#    - Qdrant UI: http://localhost:6333/dashboard
#    - Redis Exporter: http://localhost:9121/metrics
#
# 5. Production Recommendations:
#    - Change Grafana admin password (GF_SECURITY_ADMIN_PASSWORD)
#    - Enable HTTPS with reverse proxy (Caddy, Nginx)
#    - Configure alert notifications (email, Slack, PagerDuty)
#    - Increase Prometheus retention for compliance (90d+)
#    - Use external storage for Qdrant (NFS, EBS, etc.)
#    - Enable authentication on all endpoints
#
# 6. Performance Optimization:
#    - Qdrant: Adjust segment_number based on data size
#    - Prometheus: Tune scrape_interval based on load
#    - Grafana: Use query caching for dashboards
#    - Redis Exporter: Limit CHECK_KEYS to reduce overhead
#
# 7. Troubleshooting:
#    - Qdrant not starting: Check volume permissions, increase memory
#    - Prometheus no data: Verify /metrics endpoint on synapse_core
#    - Grafana no dashboards: Check provisioning directory mounts
#    - Redis Exporter errors: Verify MEMEX_PASSWORD matches
#
# 8. Backup Automation:
#    - Use ./scripts/backup-cgrag-indexes.sh for automated backups
#    - Schedule via cron for production (daily recommended)
#    - Retention: Keep 7 daily, 4 weekly, 12 monthly backups
# =============================================================================
